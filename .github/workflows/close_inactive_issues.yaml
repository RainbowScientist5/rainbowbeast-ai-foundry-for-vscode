- name: Get inactive issues and close them
  env:
    GH_TOKEN: ${{ github.token }}
  run: |
    REPO="${{ github.repository }}"

    # Check whether issues are enabled for the repository
    HAS_ISSUES=$(gh repo view "$REPO" --json hasIssues --jq '.hasIssues')
    echo "hasIssues=$HAS_ISSUES"
    if [ "$HAS_ISSUES" != "true" ]; then
      echo "Repository has issues disabled; skipping issue-close workflow."
      exit 0
    fi

    # Get the date from previous step
    CUTOFF_DATE="${{ steps.last-month.outputs.date }}"
    echo "Looking for issues updated before: $CUTOFF_DATE"

    ISSUE_LIST=$(gh issue list --limit 100 --search "updated:<$CUTOFF_DATE" --json number,title,updatedAt --jq '.[] | "\(.number) \(.title)"')

    if [ -z "$ISSUE_LIST" ]; then
      echo "No inactive issues found"
      exit 0
    fi

    echo "Found inactive issues:"
    echo "$ISSUE_LIST"

    gh issue list --limit 100 --search "updated:<$CUTOFF_DATE" --json number --jq '.[].number' | while read issue_number; do
      if [ ! -z "$issue_number" ]; then
        echo "Processing issue #$issue_number"

        ISSUE_LABELS=$(gh issue view $issue_number --json labels --jq '.labels[].name' | tr '\n' ' ')
        if [[ "$ISSUE_LABELS" =~ (^| )triage-needed( |$) ]]; then
          echo "Issue #$issue_number has triage-needed label, skipping"
          continue
        fi

        # Ensure the close comment is properly quoted (no unescaped newlines/quotes)
        gh issue close $issue_number --comment "Due to lack of details for further investigation, we will archive the issue for now. If you still have follow-up info, please reopen or comment with details."

        echo "Closed issue #$issue_number"
      fi
    done
